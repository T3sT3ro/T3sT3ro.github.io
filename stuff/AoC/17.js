t = [
    // ".#.",
    // "..#",
    // "###",
    ".###.#.#", 
    "####.#.#", 
    "#.....#.", 
    "####....", 
    "#...##.#", 
    "########", 
    "..#####.", 
    "######.#"
];

cube = [[t.map(ts => ts.split('').map(c => c == '.' ? 0 : 1))]];

function relax(d){

    let [wd, xd, yd, zd] = [d.length, d[0].length, d[0][0].length, d[0][0][0].length]
    let r = [];
    
    for(let w=-1; w <= wd; ++w){
    for(let x=-1; x <= xd; ++x){
    for(let y=-1; y <= yd; ++y){
    for(let z=-1; z <= zd; ++z){

        let sum = 0;

        sum += (((d[w - 1] || [])[x - 1] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x - 1] || [])[y + 1] || [])[z + 1] || 0;
        // ----((-------- || [])------- || [])-------------
        sum += (((d[w - 1] || [])[x    ] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x    ] || [])[y + 1] || [])[z + 1] || 0;
        // ----((-------- || [])------- || [])-------------
        sum += (((d[w - 1] || [])[x + 1] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w - 1] || [])[x + 1] || [])[y + 1] || [])[z + 1] || 0;
        
        
        
        sum += (((d[w    ] || [])[x - 1] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x - 1] || [])[y + 1] || [])[z + 1] || 0;
        // ----((-----    || [])------- || [])-------------
        sum += (((d[w    ] || [])[x    ] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y    ] || [])[z - 1] || 0;
        //sum+=(((d[w    ] || [])[x    ] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x    ] || [])[y + 1] || [])[z + 1] || 0;
        // ----((-----    || [])------- || [])-------------
        sum += (((d[w    ] || [])[x + 1] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w    ] || [])[x + 1] || [])[y + 1] || [])[z + 1] || 0;
        
        
        
        
        sum += (((d[w + 1] || [])[x - 1] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x - 1] || [])[y + 1] || [])[z + 1] || 0;
        // ----((-----+-- || [])------- || [])-------------
        sum += (((d[w + 1] || [])[x    ] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x    ] || [])[y + 1] || [])[z + 1] || 0;
        // ----((-----+-- || [])------- || [])-------------
        sum += (((d[w + 1] || [])[x + 1] || [])[y - 1] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y - 1] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y - 1] || [])[z + 1] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y    ] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y    ] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y    ] || [])[z + 1] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y + 1] || [])[z - 1] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y + 1] || [])[z    ] || 0;
        sum += (((d[w + 1] || [])[x + 1] || [])[y + 1] || [])[z + 1] || 0;

        // console.log([w, x,y,z] + `\t = ${sum}`)
        let [ww, wx, wy, wz] = [w+1, x+1,y+1,z+1];
        if(!r[ww])          r[ww] = []
        if(!r[ww][wx])      r[ww][wx] = [];
        if(!r[ww][wx][wy])  r[ww][wx][wy] = [];
        
        if(sum == 3 || ((((d[w] || [])[x] || [])[y] || [])[z] || 0) == 1 && sum == 2) 
            r[ww][wx][wy][wz] = 1;
        else
            r[ww][wx][wy][wz] = 0;

        }
        }
        }
        }

    return r;
}

relaxed = relax(relax(relax(relax(relax(relax(cube)))))) //.forEach((cx, i) => console.log(`z=${i}\n` + cx.map(ts => ts.join('').replaceAll('1', '#').replaceAll('0', '.')).join('\n')))

relaxed.flat(4).reduce((a, b) => a+b )